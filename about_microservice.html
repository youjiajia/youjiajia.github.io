<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="聊一聊微服务"><meta name="keywords" content="微服务,架构"><meta name="author" content="JASON YOU,undefined"><meta name="copyright" content="JASON YOU"><title>聊一聊微服务 | JASONUのBlog</title><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5b0e70389b44efb0724f113f74fc19ce";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  localSearch: {"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}"},"path":"search.xml"}
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是微服务？"><span class="toc-number">1.</span> <span class="toc-text">什么是微服务？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务的核心思想"><span class="toc-number">2.</span> <span class="toc-text">微服务的核心思想</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务的优势"><span class="toc-number">3.</span> <span class="toc-text">微服务的优势</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用API网关构建微服务"><span class="toc-number">4.</span> <span class="toc-text">使用API网关构建微服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务中的服务发现"><span class="toc-number">5.</span> <span class="toc-text">微服务中的服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端发现模式"><span class="toc-number">5.1.</span> <span class="toc-text">客户端发现模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务端发现模式"><span class="toc-number">5.2.</span> <span class="toc-text">服务端发现模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#事件驱动的数据管理"><span class="toc-number">6.</span> <span class="toc-text">事件驱动的数据管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#实现原子化的方案"><span class="toc-number">6.1.</span> <span class="toc-text">实现原子化的方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#采用多步骤本地事务的方法发布事件"><span class="toc-number">6.1.0.1.</span> <span class="toc-text">采用多步骤本地事务的方法发布事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#挖掘数据库事务日志，然后提交日志实现日志发布"><span class="toc-number">6.1.0.2.</span> <span class="toc-text">挖掘数据库事务日志，然后提交日志实现日志发布</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用事件源"><span class="toc-number">6.1.0.3.</span> <span class="toc-text">使用事件源</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#如何重构单体应用到微服务"><span class="toc-number">7.</span> <span class="toc-text">如何重构单体应用到微服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#END"><span class="toc-number">8.</span> <span class="toc-text">END</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/favicon.ico"></div><div class="author-info__name text-center">JASON YOU</div><div class="author-info__description text-center">JASONUのBlog</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">2</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">3</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/back.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">JASONUのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">聊一聊微服务</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-04-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/架构/">架构</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h1 id="什么是微服务？"><a href="#什么是微服务？" class="headerlink" title="什么是微服务？"></a>什么是微服务？</h1><blockquote>
<p>微服务现在受到了大量的关注︰ 文章、 博客、 社交媒体和学术会议上的讨论都能看到该词汇的身影。微服务正迅速走向所指的快速发展期。同时，软件社区的一些怀疑论者指出微服务并不是什么新鲜玩意儿。这些唱反调的人说微服务和SOA概念并没有什么不同，旧瓶装新酒而已，顺势炒炒新概念。然而，不管说是夸大也好，怀疑也罢，微服务架构模式应用在敏捷开发和交付复杂的企业应用程序的时候还是有巨大优势的。</p>
</blockquote>
<blockquote>
<p>一句话总结SOA和微服务的区别，即微服务不再强调传统SOA架构里面比较重的ESB企业服务总线，同时SOA思想进入单个业务系统内部实现真正的组件化。</p>
</blockquote>
<h1 id="微服务的核心思想"><a href="#微服务的核心思想" class="headerlink" title="微服务的核心思想"></a>微服务的核心思想</h1><p>微服务的基本思想在于考虑围绕业务领域组件来创建应用，这些应用可独立的进行开发、管理和加速。在分散的组件中使用微服务云架构和平台使部署、管理和服务功能交付变得更加简单。</p>
<p>微服务核心包括，其一足够构成一个独立小应用（从DB到UI），其二微服务应用之间只能通过ServiceAPI进行交互，其三一般运行在云虚拟机或更轻的docker容器上。微服务架构的重点就是业务系统需要彻底的组件化和服务化，原有的单个业务系统会拆分成多个可以独立开发，设计，运行和运维的小应用。这些小应用之间通过服务完成交互和集成。</p>
<p>对于微服务架构下首先仍然是要做好单个组件本身的持续集成，其次在这个基础上增加了多个组件的打包部署和组件间的集成。里面的核心思想就是Devops的思路，希望能够实现开发设计到运维部署的一体化。</p>
<h1 id="微服务的优势"><a href="#微服务的优势" class="headerlink" title="微服务的优势"></a>微服务的优势</h1><p>一个成功的应用总会随着时间逐步成长并变得巨大起来。每个敏捷Sprint周期，开发者会实现更多的功能，当然这就意味着又添加了很多行代码。时间长了后，当年写的小小的单体应用已经变成了巨大的单体怪物。而微服务则在这方面展现出他的优势：</p>
<ul>
<li>通过分解巨大单体应用为多个服务方法解决了复杂性问题。同时单个服务很容易开发，理解和维护。</li>
<li>这种架构使得每个服务都可以有专门开发团队来开发。开发者可以自由选择技术，提供API服务。</li>
<li>微服务架构使得每个微服务独立部署，开发者不再需要协调其他服务部署对本服务的影响</li>
<li>微服务架构模式使得每个服务独立扩展。</li>
</ul>
<p>微服务的目的是有效的拆分应用，实现敏捷开发和部署。和其他技术一样，微服务架构也有其劣势。</p>
<ul>
<li>微服务应用是分布式系统，由此会带来固有的复杂性，开发者需要在RPC或者消息传递之间选择并完成进程间的通讯机制。</li>
<li>分区的数据库架构，因为更新多个业务主体的事务很普遍。使用分布式事务并不一定是好的选择，不仅仅因为CAP理论，还因为当前高扩展性的nosql和消息传递中间件并不支持这一需求。最终不得不使用一个最终一致性的方法，从而对开发者提出了更高的要求和挑战。</li>
<li>部署和测试一个基于微服务架构的应用也是一个很复杂的任务</li>
<li>微服务架构模式应用的改变将会波及多个服务。</li>
</ul>
<h1 id="使用API网关构建微服务"><a href="#使用API网关构建微服务" class="headerlink" title="使用API网关构建微服务"></a>使用API网关构建微服务</h1><p>当我们选择把应用构建成一组微服务的时候，我们需要决定应用的客户端如何与这些微服务进行交互。</p>
<p>理论上客户端可以直接与每一个微服务进行通信，但是这种方案有诸多挑战和限制。</p>
<ol>
<li>客户端需求和每个微服务暴露的细粒度API不匹配。简单来说就是一个页面需要发送太多次的api请求，这种方法还使得客户端代码非常复杂。</li>
<li>部分服务协议对web并不友好</li>
<li>会使得微服务难以重构，比如未来想要合并，或拆分单个微服务非常困难。</li>
</ol>
<p>通常来说，API网关是更好的解决方式。API网关是个服务器，也可以说是进入系统的唯一节点。API网关封装内部系统的架构，并且提供API给各个客户端。它还可能具备授权，监控，负载均衡，缓存，请求分片和管理，静态响应处理等功能。因此，将API网关构建在一个支持异步，I/O非阻塞的平台是合理的。可用使用node.js。</p>
<p>对于API网关需要实现底层多个细粒度的API组合的场景，推荐采用响应式编程模型进行而不是传统的异步回调方法组合代码。其原因除了采用回调方式导致的代码混乱外，还有就是对于API组合本身可能存在并行或先后调用，对于采用回调方式往往很难控制。同时在实现API网关时，还需要处理局部失败的问题（服务响应慢或不可用的时候）。如果缓存数据可用，API网关还可以返回缓存数据。另外，API网关支持不同的通信机制，包括异步和同步两种类型的进程间通信机制，甚至还可能有同一类型的多种实现。</p>
<p>总结一下API网关的优缺点：</p>
<ul>
<li><p>最大的优点是，它封装了应用程序的内部结构。它和传统ESB的区别就是API网关更加轻量和高性能，他不需要考虑太多遗留系统和诸多协议的适配，其次也不需要考虑服务集成过程中的大量数据转换和映射。</p>
</li>
<li><p>缺点是它增加了一个我们必须开发、部署和维护的高可用组件。还有一点是，在我们期望的去中心化和全分布式架构中，API网关又变成了一个中心点或瓶颈点。</p>
</li>
</ul>
<h1 id="微服务中的服务发现"><a href="#微服务中的服务发现" class="headerlink" title="微服务中的服务发现"></a>微服务中的服务发现</h1><p>为了完成一次请求，代码需要知道服务实例的网络地址，对基于云端、现代化的微服务而言，服务实例的网络位置都是动态分配的，所以需要服务发现机制。服务发现分为客户端发现模式和服务端发现模式。</p>
<h2 id="客户端发现模式"><a href="#客户端发现模式" class="headerlink" title="客户端发现模式"></a>客户端发现模式</h2><p>客户端查询服务注册表（可用服务实例的数据库），用负载均衡算法选择一个实例，发出请求。即如何一个服务的消费都需要分成两个步骤进行，第一步访问服务注册库，第二步客户端与改服务建立连接。<br>缺点：底层ip暴露出来了，需要进一步做安全和防火墙隔离的场景下是不能用的。</p>
<h2 id="服务端发现模式"><a href="#服务端发现模式" class="headerlink" title="服务端发现模式"></a>服务端发现模式</h2><p>客户端通过负载均衡器向某个服务提出请求，负载均衡器查询注册表，并将请求转发到可用的服务实例。优点是客户端无需发现细节。缺点是负载均衡器是一个需要配置和管理的高可用系统组件。</p>
<p>服务注册表是服务发现的关键部分，它是一个包含服务实例网络地址的的数据库。一个服务注册表需要高可用和实时更新，客户端可以缓存从服务注册表获取的网络地址。必须多台部署（否则有单点故障），同时要考虑多台机器信息的实时同步和一致。</p>
<p>服务实例必须在注册表注册和注销。注册和注销有两种不同的方法。一是实例自己注册（更容易实现，但是注册库本身应该具备服务节点心跳检测能力）。另一种是赛用管理服务实例注册的其他系统组件，即第三方注册模式。</p>
<p>常用的服务注册表例子包括：</p>
<ul>
<li>etcd ，一个高可用、分布式、一致性、key-value 方式的存储，被用在分享配置和服务发现中。两个著名的项目使用了它：Kubernetes 和 Cloud Foundry.</li>
<li>consul ，一个发现和配置服务的工具，为客户端注册和发现服务提供了API，Consul还可以通过执行健康检查决定服务的可用性。</li>
<li>Apache Zookeeper ，是一个广泛使用、高性能的针对分布式应用的协调服务。 Apache Zookeeper本来是Hadoop的子工程，现在已经是顶级工程了。</li>
</ul>
<h1 id="事件驱动的数据管理"><a href="#事件驱动的数据管理" class="headerlink" title="事件驱动的数据管理"></a>事件驱动的数据管理</h1><p>一个单体应用一般只有一个关系型数据库，使用一个关系型数据的优势是应用可以实现ACID。因此，应用可以很简单的开始一个事务，操作（增删改）多条数据，然后提交事务。</p>
<p>在微服务架构中，每个微服务都有其私有数据库存储，不同的微服务可能使用不同的SQL和NoSQL数据库。这些数据库架构带来便利的同时，也给分布式数据管理带来挑战。一方面是如何实现业务事务，保持多个服务的一致性。另一方面就是如何从多个服务中检索数据，实现查询。</p>
<p>对于许多应用，解决方案就是事件驱动的架构。在这一架构中，当有显著事件发生时，某个微服务会发布事件，其他微服务则订阅这些事件。当某一微服务接收到事件就可以更新自己的业务实现，实现更多事件被发布。</p>
<p>事件驱动的优点：它使事务跨多个服务并提供最终一致性。缺点之一在于它的编程模型比ACID事务更加复杂，另外一个劣势就是订阅必须可以检测并忽略重复的事件。另外，事件驱动架构还存在以原子粒度更新数据库并发布事件的问题。</p>
<h2 id="实现原子化的方案"><a href="#实现原子化的方案" class="headerlink" title="实现原子化的方案"></a>实现原子化的方案</h2><h4 id="采用多步骤本地事务的方法发布事件"><a href="#采用多步骤本地事务的方法发布事件" class="headerlink" title="采用多步骤本地事务的方法发布事件"></a>采用多步骤本地事务的方法发布事件</h4><p>技巧就是有一张event表，更新业务就往event表中插入一条记录，然后提交事务，一个单独应用轮询event表，并根据查询结果来推送。</p>
<p>这种方案优势是保证了在不使用两段提交前提下事件在每次更新后一定被发布。劣势之一是方案容易出错，程序员必须记得更新后去发布才行，另外一点就是使用nosql时，nosql事务和查询能力有限，实现起来困难。</p>
<h4 id="挖掘数据库事务日志，然后提交日志实现日志发布"><a href="#挖掘数据库事务日志，然后提交日志实现日志发布" class="headerlink" title="挖掘数据库事务日志，然后提交日志实现日志发布"></a>挖掘数据库事务日志，然后提交日志实现日志发布</h4><p>这种方案的优势在于不使用两段提交的前提下保证了事件一定被发布，事务日志挖掘也可以通过拆分应用业务逻辑事件的发布简化整个应用。劣势是：事务日志每个数据库都不同，甚至同一数据库不同版本也会不同，而且我们很难从低级别的事务日志的更新记录中反推高级别的业务事件。</p>
<h4 id="使用事件源"><a href="#使用事件源" class="headerlink" title="使用事件源"></a>使用事件源</h4><p>这种方案存储一系列状态变化的事件而不是存储当前实体的状态。一旦业务实体发生变化，一个新的事件就会被添加到事件列表中，由于保存事件是单一操作，本身就是原子性的。</p>
<p>事件源的优势在于它使得事件发生时可靠的发布事件成为可能，解决了微服务架构中的数据一致性问题。另外一点就是，业务逻辑与交换事件的实体是松耦合的，这使得迁移一个单体应用到微服务架构更加简单</p>
<p>事件源的劣势子在于，事件数据库对程序员来说很陌生，它仅仅支持主键的方式查询业务实体，必须使用CQRS来实现查询。因此，应用必须处理最终一致性。</p>
<h1 id="如何重构单体应用到微服务"><a href="#如何重构单体应用到微服务" class="headerlink" title="如何重构单体应用到微服务"></a>如何重构单体应用到微服务</h1><p>从一个现存应用迁移到微服务的过程是应用现代化的一种形式，不应该以从头完全重写的方式把现存应用变为微服务，相反的，应该逐步的把应用重构为一系列的微服务。可以使用三种策略：使用微服务实现新的功能；把表现层从业务逻辑和数据访问组件中拆分出来；把单体应用中的现有模块转化为服务。随着时间推移，微服务的数量将会增长，团队的敏捷性和开发速度也会提升。</p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1><p>本文大部分内容源自阅读nginx blog上的大神Chris Richardson发布的<a href="https://www.nginx.com/blog/introduction-to-microservices/" target="_blank" rel="noopener">七篇针对微服务的文章</a>，刚好公司最近正在将一个传统应用迁移至微服务，自己阅读理解的同时将笔记分享出来。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">JASON YOU</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://www.pyjason.com/about_microservice.html">http://www.pyjason.com/about_microservice.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/微服务/">微服务</a><a class="post-meta__tags" href="/tags/架构/">架构</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/wei.png"><div class="post-qr-code__desc">微信打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/zfb.png"><div class="post-qr-code__desc">支付宝打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/about_fabric.html"><i class="fa fa-chevron-left">  </i><span>fabric 服务器管理和应用发布神器</span></a></div></nav><div id="lv-container" data-id="city" data-uid="MTAyMC8zNTk1MS8xMjQ4Nw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 By JASON YOU</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>