<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="docker核心原理"><meta name="keywords" content="docker"><meta name="author" content="JASON YOU,undefined"><meta name="copyright" content="JASON YOU"><title>docker核心原理 | JASONUのBlog</title><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5b0e70389b44efb0724f113f74fc19ce";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  localSearch: {"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}"},"path":"search.xml"}
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-原理综述"><span class="toc-number">1.</span> <span class="toc-text">docker 原理综述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#namespace"><span class="toc-number">1.0.1.</span> <span class="toc-text">namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cgroups"><span class="toc-number">1.0.2.</span> <span class="toc-text">cgroups</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker架构概览"><span class="toc-number">2.</span> <span class="toc-text">docker架构概览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker镜像管理："><span class="toc-number">3.</span> <span class="toc-text">docker镜像管理：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-数据卷volum"><span class="toc-number">4.</span> <span class="toc-text">docker 数据卷volum</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/favicon.ico"></div><div class="author-info__name text-center">JASON YOU</div><div class="author-info__description text-center">JASONUのBlog</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">6</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">7</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/back.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">JASONUのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">docker核心原理</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-16</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/docker/">docker</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h1 id="docker-原理综述"><a href="#docker-原理综述" class="headerlink" title="docker 原理综述"></a>docker 原理综述</h1><p>docker相比于虚拟机，在资源利用上的效率比虚拟机高出很多，另外docker的启动速度也是虚拟机不能比的，那么docker是如何实现这些的呢。首先docker基于Linux，通过Linux的namespace实现了资源隔离，通过cgroups实现了资源限制，通过写时复制机制（copy-on-write）技术实现了高效的文件操作。</p>
<h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p>namespace隔离，docker使用了六种隔离方式,分别为UTS(主机名和域名)，IPC(信号量，消息队列和共享内存)，PID(进程编号)，Network(网络设备，网络栈，端口等),Mount(挂载点),User(用户和用户组)。Linux内核实现namespace的主要目的之一就是实现轻量级虚拟化服务。在同一个namespace下的进程可以感知彼此的变化，而对外界的进程一无所知，以达到独立和隔离的目的。</p>
<p>Linux中namespaceAPI操作有</p>
<ul>
<li>clone接口（创建新进程的同时创建namespace）</li>
<li>setns()接口（加入一个已经存在的namespace, docker的exec命令在已经运行的容器中执行一个新的命令就需要用到该方法）</li>
<li>unshare方法（使当前进程退出指定类型的namespace，并加入到新创建的namespace（相当于创建并加入新的namespace），与clone的不同之处在于，unshare运行在原先的进程上，不需要启动一个新的进程）</li>
</ul>
<p>可以通过查看/proc/[pid]/nc文件来查看进程所属的namespace。另外说一下Linux中的fork，调用fork时候，系统创建新的进程，为其分配资源，把原来进程中的值都复制到新进程中，只有少量值与原来不同，fork的神奇之处在于，他只被调用了一次，却能够返回两次数值（父进程返回子进程id，子进程返回0，出错返回负值）</p>
<h3 id="cgroups"><a href="#cgroups" class="headerlink" title="cgroups"></a>cgroups</h3><p>cgroups可以限制、记录任务组所使用的物理资源（包括CPU，memory，IO等），为容器实现虚拟化提供了基本保证，是构建Docker等一系列虚拟化管理工具的基石。</p>
<p>cgroups作用包括：</p>
<ol>
<li>资源限制</li>
<li>优先级分配</li>
<li>资源统计</li>
<li>任务控制</li>
</ol>
<p>cgroups包含：</p>
<ol>
<li>tasks任务：表示一个系统的进程或线程</li>
<li>cgroup控制组：表示某种资源按照控制标准划分而成的任务组，包含一个或多个子系统，任务可加入某个cgroup，也可以从某个cgroup迁移到另外一个cgroup</li>
<li>subsystem（子系统）：子系统是一个资源调度控制器。（例如CPU子系统）</li>
<li>hierarchy（层级）：由一系列cgroup以一个树状结构排列而成，每个层级通过绑定对应的子系统进行资源控制。每个节点可以包含0个或多个子节点，子节点继承父节点挂载的子系统。整个操作系统可以有多个层级。</li>
</ol>
<h1 id="docker架构概览"><a href="#docker架构概览" class="headerlink" title="docker架构概览"></a>docker架构概览</h1><ul>
<li>docker daemon 是docker最核心的后台进程，负责响应docker client请求，然后将请求翻译成系统调用完成容器管理工作。<ul>
<li>其中容器管理驱动execdriver是daemon的一个重要组成部分，它封装了namespace，cgroup，等对os资源进行操作的所有方法，在docker中，其默认实现就是libcontainer。libcontainer本身主要分为三大块内容，一是容器的创建及初始化，二是容器生命周期管理，三是进程管理，由docker的execdriver来调用。</li>
</ul>
</li>
<li>docker client 是一个泛称，用来向docker daemon发起请求，执行响应容器管理的操作</li>
<li>graph组件负责维护已下载的镜像信息及他们之间的关系。</li>
<li>graphdb记录它所维护的所有容器以及他们之间的link关系，所以采用了一个图结构来保存这些数据。（基于sqlite实现）</li>
<li>driver 是为了将系统调用抽象成为统一的操作接口，方便调用者使用，docker将这些操作分类成容器管理驱动(execdriver)、网络管理驱动(networkdriver)、文件存储驱动(graphdriver)三种。</li>
</ul>
<h1 id="docker镜像管理："><a href="#docker镜像管理：" class="headerlink" title="docker镜像管理："></a>docker镜像管理：</h1><p>docker镜像采用分层的结构构建，最底层是bootfs，之上的部分是rootfs。bootfs是docker镜像最底层的引导文件系统，包括bootloader和操作系统内核。rootfs位于bootfs之上，是docker容器在启动时内部进程可见的文件系统，即docker容器的根目录。</p>
<p>在传统的Linux操作系统的内核启动时，首先挂载一个只读的rootfs，当系统检测其完整性之后，再将其切换为读写模式。而在docker架构中，当docker daemon为docker容器挂载rootfs时，沿用Linux内核启动的方法，即将rootfs设为只读模式。在挂载完毕之后，利用联合挂载技术（union mount）在已有的只读rootfs上再挂载一个读写层，只有在docker容器运行过程中文件系统发生变化时，才会把变化的内容写到可读写层，并隐藏只读层中的老版本文件，这样的技术被称为写时复制。</p>
<p>docker 镜像管理关键概念:</p>
<ul>
<li>registry: 用以保存docker镜像，其中还包括镜像层次结构和关于镜像的元数据</li>
<li>repository: 由具有某个功能的docker镜像的所有迭代版本构成的镜像库，即registry是repository的集合，repository是镜像的集合</li>
<li>index: 类似于registry的索引，复制搜索镜像，打标签等服务</li>
<li>graph: 负责保存从registry中下载的docker镜像</li>
<li>dockerfile: 通过dockerbuild命令构建自己的docker镜像时，需要使用到的定义文件</li>
</ul>
<h1 id="docker-数据卷volum"><a href="#docker-数据卷volum" class="headerlink" title="docker 数据卷volum"></a>docker 数据卷volum</h1><pre><code>添加volume类似于Linux的mount操作，用户将一个文件夹作为volume挂载在容器上，可以方便的将数据添加到容器中供其中的进程使用。多个容器可以共享同一个volume，为了不同的容器之间的数据共享提供了便利。
</code></pre></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">JASON YOU</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://www.pyjason.com/docker_core_principles.html">http://www.pyjason.com/docker_core_principles.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/docker/">docker</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/wei.png"><div class="post-qr-code__desc">微信打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/zfb.png"><div class="post-qr-code__desc">支付宝打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/bdd_profile.html"><i class="fa fa-chevron-left">  </i><span>BDD行为驱动开发概要</span></a></div><div class="next-post pull-right"><a href="/docker_common_commands.html"><span>docker常用命令</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="lv-container" data-id="city" data-uid="MTAyMC8zNTk1MS8xMjQ4Nw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2021 By JASON YOU</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>